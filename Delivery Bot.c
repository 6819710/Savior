#pragma config(Sensor, S1,     colorSensor,    sensorEV3_Color, modeEV3Color_Color)
#pragma config(Sensor, S4,     sonarSensor,    sensorEV3_Ultrasonic)
#pragma config(Motor,  motorA,          gripperMotor,  tmotorEV3_Medium, PIDControl, encoder)
#pragma config(Motor,  motorB,          leftMotor,     tmotorEV3_Large, PIDControl, driveLeft, encoder)
#pragma config(Motor,  motorC,          rightMotor,    tmotorEV3_Large, PIDControl, driveRight, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

int gripperRange = 5;
int correctionRange = 8;
int errorMargin = 2;
int gripperSpeed = 50;
int drivingSpeed = 25;
int drivingDuration = 2500;

//Variables
int currentDistance = 0;
bool gripperOpen = true;
bool delivered = false;
bool correcting = false;
int correctionDuration = 0;

void stopMove()
{
	setMotorSpeed(leftMotor, 0);
	setMotorSpeed(rightMotor, 0);
}

void forwardMove()
{
	setMotorSpeed(leftMotor, drivingSpeed);
	setMotorSpeed(rightMotor, drivingSpeed);	
}

void forwardMove(int duration)
{
	forwardMove();
	sleep(duration);
	stopMove();
}

void backwardMove()
{
	setMotorSpeed(leftMotor, -drivingSpeed);
	setMotorSpeed(rightMotor, -drivingSpeed);
}

void backwardMove(int duration)
{
	backwardMove();
	sleep(duration);
	stopMove();
}

void closeGripper()
{
	resetMotorEncoder(gripperMotor);
	setMotorSpeed(gripperMotor, -gripperSpeed);
	while (getMotorEncoder(gripperMotor) > -1500) {}
	setMotorSpeed(gripperMotor, 0);
	gripperOpen = false;
}

void openGripper()
{
	resetMotorEncoder(gripperMotor);
	setMotorSpeed(gripperMotor, gripperSpeed);
	while (getMotorEncoder(gripperMotor) < 1500) {}
	setMotorSpeed(gripperMotor, 0);
	gripperOpen = true;
}

task main()
{
	//Infinite Loop
	while(true)
	{
		// Read the sensor
		currentDistance = getUSDistance(sonarSensor);
		
		// Open gripper if delivered flag and gripper is closed.
		if(delivered && !gripperOpen)
		{
			openGripper();
		}
	
		// Stop Moving and Close Gripper if payload is detected in gripper range
		if(!delivered && gripperOpen && ((gripperRange - currentDistance) > 0))
		{
			if (correcting) // Set correction duration 
			{
				correctionDuration = time1[T1];
				correcting = false;
			}
			stopMove();
			closeGripper();
		}
		
		// Move to payload if payload is detected outside of gripper range
		if(!delivered && gripperOpen && ((gripperRange - currentDistance) > -correctionRange))
		{
			if(!correcting) // Reset Timer if not currently correcing.
			{
				clearTimer(T1); 
				correcting = true;
			}
			forwardMove();
		}
		
		// Move to desitination if not delivered and grippers closed
		if(!delivered && !gripperOpen)
		{
			forwardMove(drivingDuration);
			delivered = true;
		}
			
		//TODO: F
		if(!delivered &&(currentDistance > (gripperRange+correctionRange+errorMargin)))
		{
			stopMove();
		}
		
		// Return to carrier if delivered and gripper opened
		if(delivered && gripperOpen)
		{
			backwardMove(drivingDuration);
			backwardMove(correctionDuration);
			delivered = false;
			currentDistance = 0;
		}
	}
}
